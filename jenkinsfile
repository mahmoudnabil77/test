pipeline {
    agent any
    environment {
        // Get minikube docker-env config (cross-platform compatible)
        DOCKER_CONFIG = sh(script: 'minikube docker-env --shell=bash | grep -v "^#"', returnStdout: true).trim()
    }
    stages {
        stage('Build Docker Image') {
            steps {
                script {
                    // Apply minikube docker-env settings
                    withEnv(["DOCKER_CONFIG=${DOCKER_CONFIG}"]) {
                        sh '''
                        eval "$DOCKER_CONFIG"
                        docker build -t hello-devops .
                        '''
                    }
                }
            }
        }
        stage('Deploy to Minikube') {
            steps {
                sh 'kubectl apply -f deployment.yaml'
                sh 'kubectl rollout status deployment/hello-devops'
            }
        }
    }
}
